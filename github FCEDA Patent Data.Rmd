---
title: "FCEDA Patent Dataset Cleaner"
author: "PREP Team"
date: "2025-11-19"
output: pdf_document
---
# Load Library
```{r}
library(dplyr)
library(readr)
library(stringr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(scales)
```

# Load Dataset

```{r}
DATA <- "/Users/thanhhuuquach/Desktop/MIS 462/FCEDA/Dataset"
```

## g_application
### Imports the g_application.tsv file from the dataset folder and extracts only the relevant columns — patent_id and filing_date.
```{r}
application <- read_tsv(file.path(DATA, "g_application.tsv"),
                     col_select = c(patent_id,
                                    filing_date),
                     col_types = cols(patent_id   = col_character(),
                                      filing_date = col_date()),
                     show_col_types = FALSE
)
```

## g_assignee_disambiguated
### Imports the g_assignee_disambiguated.tsv file from the dataset folder and extracts only the relevant columns — assignee_type, assignee_sequence, disambig_assignee_individual_name_first, disambig_assignee_individual_name_last, disambig_assignee_organization,location_id.
```{r}
assignee <- read_tsv(file.path(DATA, "g_assignee_disambiguated.tsv"),
                     col_select = c(patent_id, assignee_id, 
                                    assignee_type, assignee_sequence, 
                                    disambig_assignee_individual_name_first,
                                    disambig_assignee_individual_name_last,
                                    disambig_assignee_organization,
                                    location_id
                                    ),
                     col_types = cols(patent_id   = col_character(),
                                      assignee_id = col_character(),
                                      assignee_sequence = col_integer(),
                                      assignee_type     = col_integer(),
                                      disambig_assignee_individual_name_first = col_character(),
                                      disambig_assignee_individual_name_last  = col_character(),
                                      disambig_assignee_organization          = col_character(),
                                      location_id = col_character()
                                      ),
                     show_col_types = FALSE
)
```

## g_location_disambiguated
### Imports the g_application.tsv file from the dataset folder and extracts only the relevant columns — location_id, disambig_city, disambig_state, disambig_country, latitude, longitude, county.
```{r}
location <- read_tsv(file.path(DATA, "g_location_disambiguated.tsv"),
                     col_select = c(location_id, disambig_city, 
                                    disambig_state, disambig_country, 
                                    county
                                    ), 
                     col_types = cols(location_id = col_character(), 
                                    disambig_city = col_character(), 
                                    disambig_state = col_character(), 
                                    disambig_country = col_character(), 
                                    county = col_character()
                                    ),
                     show_col_types = FALSE
)
```

## g_cpc_current
###  Imports the g_application.tsv file from the dataset folder and extracts only the relevant columns — patent_id, cpc_sequence, cpc_section, cpc_class, cpc_subclass, cpc_group, cpc_type.
```{r}
cpc_current <- read_tsv(file.path(DATA, "g_cpc_current.tsv"),
                     col_select = c(patent_id, cpc_sequence, cpc_section, cpc_class, cpc_subclass, cpc_group, cpc_type),
                     col_types = cols(
                       patent_id = col_character(),
                       cpc_sequence = col_integer(),
                       cpc_section = col_character(),
                       cpc_class = col_character(),
                       cpc_subclass = col_character(),
                       cpc_group = col_character(),
                       cpc_type = col_character()
                     ),
                     show_col_types = FALSE
)
```

## g_cpc_title
###  Imports the g_application.tsv file from the dataset folder and extracts only the relevant columns — cpc_subclass, cpc_subclass_title, cpc_group, cpc_group_title, cpc_class, cpc_class_title.
```{r}
cpc_title <- read_tsv(file.path(DATA, "g_cpc_title.tsv"),
                     col_select = c(cpc_subclass, cpc_subclass_title, cpc_group, cpc_group_title, cpc_class, cpc_class_title),
                     col_types = cols(
                       cpc_subclass = col_character(),
                       cpc_subclass_title = col_character(),
                       cpc_group = col_character(),
                       cpc_group_title = col_character(),
                       cpc_class = col_character(),
                       cpc_class_title = col_character()
                     ),
                     show_col_types = FALSE
)
```

# Filtering
## Filter Assignee Primary
### Keep only primary assignees (assignee_sequence = 0) to avoid duplicate patent_id entries.
### Each patent may have multiple assignees, but only the primary one is retained.
```{r}
assignees_primary <- assignee %>% filter(assignee_sequence == 0)
```

## Filter Country
### Keep the country at US only. 
```{r}
location_us <- location %>%
  filter(str_to_upper(disambig_country) == "US")
```

## Filter Cpc
### Keep the cpc primary. 
```{r}
cpc_primary <- cpc_current %>%
  filter(cpc_sequence == 0)
```

## Add label for the assignee group
```{r}
assignee_labels <- c(
  `2` = "US Company or Corporation",
  `3` = "Foreign Company or Corporation",
  `4` = "US Individual",
  `5` = "Foreign Individual",
  `6` = "US Federal Government",
  `7` = "Foreign Government",
  `8` = "US County Government",
  `9` = "US State Government"
)
```

# Combine Dataset
## Assignee LEFT JOIN Location
### Keeps all location_us records while adding matching assignee details.
```{r}
assignee_location <- location_us %>%
  left_join (assignees_primary, by = "location_id")
```
-> A left join is used to keep all records from the location_us table (ensuring that every location is preserved), while bringing in matching information from the assignees_primary dataset. This helps associate each assignee’s details—such as name, organization type, and ID—with their corresponding geographic location (city, state, county, latitude, and longitude).

## Cpc_current LEFT JOIN Title
```{r}
cpc_combined <- cpc_primary %>%
  left_join(cpc_title, by = c("cpc_class", "cpc_subclass", "cpc_group"))
```
-> Keep all record from cpc_primary table(ensuring that every Cooperative Patent Classification is preserved), while bringing in matching information from the cpc_primary dataset.


## Applications LEFT JOIN assignee_location, inventor_primary, gov_agg
```{r}
apps <- application %>%
  left_join(assignee_location, by = "patent_id") %>%
  left_join(cpc_combined, by = "patent_id") %>%

  transmute(
    patent_id,
    Assignee_Name = coalesce(
      str_squish(disambig_assignee_organization),
      str_squish(paste(disambig_assignee_individual_name_first,
                       disambig_assignee_individual_name_last))
    ),
    Assignee_Type_Code = assignee_type,
    Assignee_Group_Title = if_else(
      is.na(assignee_type),
      "Unassigned",
      coalesce(unname(assignee_labels[as.character(assignee_type)]), "Unassigned")
    ),
    Assignee_Group = if_else(
      is.na(assignee_type),
      "Unassigned",
      paste0(assignee_type, " - ", Assignee_Group_Title)
    ),
    Assignee_Descriptive_Text = str_squish(
      if_else(!is.na(Assignee_Name) & Assignee_Name != "",
              paste0(Assignee_Name, " — ", Assignee_Group_Title),
              Assignee_Group_Title)
    ),
    Application_Filing_Year = year(filing_date),
    Assignee_City   = disambig_city,
    Assignee_State  = disambig_state,
    Assignee_County = county,
    Country = disambig_country,
    cpc_subclass,
    Description_Cpc = cpc_subclass_title,
    cpc_group, 
    Description_Sub_Cpc = cpc_group_title,
    cpc_class,
    Description_Subsection_Cpc = cpc_class_title
  ) %>%
  distinct()
```

-> This section creates the final combined dataset (apps) by merging multiple key sources of patent data. The application, assignee_location, inventor_primary, and gov_agg datasets are fully joined on the shared key patent_id, ensuring that all patent records are preserved even if some information is missing in one of the tables.
  - After joining, the code constructs a set of clean and descriptive fields:
    - Assignee_Name combines organization and individual names.
    - Assignee_Type_Code, Assignee_Group_Title, and Assignee_Group classify assignees by type.
    - Assignee_Descriptive_Text provides a readable text description combining name and group title.
    - Application_Filing_Year capture time details.
    - Assignee_City, State, County, Country describe location.
    - Description_Subsection_Cpc, Description_Sub_Cpc, Description_Cpc illustrate the hierarchical CPC classification codes and their descriptive titles, enabling category-level analysis of innovation topics.
  - The final dataset is made distinct to remove duplicates and serves as the foundation for analysis of patent activity by region, assignee type, inventor demographics, and government participation.

## Filter VA
```{r}
FCEDA_VA_PatentData <- apps %>%
  filter(str_to_upper(Assignee_State) == "VA")
```


## Export to CSV file
```{r}
write_csv(FCEDA_VA_PatentData, '/Users/thanhhuuquach/Desktop/MIS 462/FCEDA/FCEDA_VA_Patent_Data.csv')
```






